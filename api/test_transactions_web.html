<!DOCTYPE html>
<html>
<head>
    <title>Transactions.php Test Suite</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .test-result { background: #f9f9f9; padding: 10px; margin: 10px 0; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Transactions.php Function Test Suite</h1>
    <p>This page tests all functions in transactions.php to ensure they work properly before integrating with admin.php.</p>

    <div class="test-section">
        <h2>1. Basic Booking Operations</h2>
        <button onclick="testFunction('bookingList')">Test bookingList()</button>
        <button onclick="testFunction('getRooms')">Test getRooms()</button>
        <button onclick="testFunction('getBookingsWithBillingStatus')">Test getBookingsWithBillingStatus()</button>
        <div id="basic-results"></div>
    </div>

    <div class="test-section">
        <h2>2. Charges Management</h2>
        <button onclick="testFunction('chargesMasterList')">Test chargesMasterList()</button>
        <button onclick="testFunction('getChargesCategory')">Test getChargesCategory()</button>
        <button onclick="testFunction('bookingChargesList')">Test bookingChargesList()</button>
        <div id="charges-results"></div>
    </div>

    <div class="test-section">
        <h2>3. Billing Functions</h2>
        <button onclick="testBillingFunction('validateBillingCompleteness', {booking_id: 1})">Test validateBillingCompleteness()</button>
        <button onclick="testBillingFunction('calculateComprehensiveBilling', {booking_id: 1, vat_rate: 0.12, downpayment: 0})">Test calculateComprehensiveBilling()</button>
        <button onclick="testBillingFunction('createBillingRecord', {booking_id: 1, employee_id: 1})">Test createBillingRecord()</button>
        <div id="billing-results"></div>
    </div>

    <div class="test-section">
        <h2>4. Booking Charges</h2>
        <button onclick="testBillingFunction('getBookingCharges', {booking_id: 1})">Test getBookingCharges()</button>
        <button onclick="testBillingFunction('getDetailedBookingCharges', {booking_id: 1})">Test getDetailedBookingCharges()</button>
        <button onclick="testBillingFunction('addBookingCharge', {booking_id: 1, charge_name: 'Test Charge', charge_price: 100, quantity: 1})">Test addBookingCharge()</button>
        <div id="booking-charges-results"></div>
    </div>

    <div class="test-section">
        <h2>5. Invoice Functions</h2>
        <button onclick="testBillingFunction('getBookingInvoice', {booking_id: 1})">Test getBookingInvoice()</button>
        <button onclick="testBillingFunction('createInvoice', {billing_ids: [1], employee_id: 1, payment_method_id: 1})">Test createInvoice()</button>
        <div id="invoice-results"></div>
    </div>

    <div class="test-section">
        <h2>6. Error Handling Tests</h2>
        <button onclick="testFunction('invalidOperation')">Test Invalid Operation</button>
        <button onclick="testBillingFunction('getVacantRoomsByBooking', {})">Test Missing Data</button>
        <div id="error-results"></div>
    </div>

    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="summary"></div>
    </div>

    <script>
        let testResults = {
            passed: 0,
            failed: 0,
            warnings: 0,
            total: 0
        };

        function testFunction(operation) {
            testResults.total++;
            const formData = new FormData();
            formData.append('operation', operation);
            
            fetch('transactions.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                displayResult(operation, data, 'basic-results');
            })
            .catch(error => {
                displayError(operation, error.message, 'basic-results');
            });
        }

        function testBillingFunction(operation, jsonData) {
            testResults.total++;
            const formData = new FormData();
            formData.append('operation', operation);
            formData.append('json', JSON.stringify(jsonData));
            
            fetch('transactions.php', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                let resultContainer = 'billing-results';
                if (operation.includes('BookingCharges') || operation.includes('addBookingCharge')) {
                    resultContainer = 'booking-charges-results';
                } else if (operation.includes('Invoice')) {
                    resultContainer = 'invoice-results';
                } else if (operation.includes('getVacantRoomsByBooking')) {
                    resultContainer = 'error-results';
                }
                displayResult(operation, data, resultContainer);
            })
            .catch(error => {
                let resultContainer = 'billing-results';
                if (operation.includes('BookingCharges') || operation.includes('addBookingCharge')) {
                    resultContainer = 'booking-charges-results';
                } else if (operation.includes('Invoice')) {
                    resultContainer = 'invoice-results';
                } else if (operation.includes('getVacantRoomsByBooking')) {
                    resultContainer = 'error-results';
                }
                displayError(operation, error.message, resultContainer);
            });
        }

        function displayResult(operation, data, containerId) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result';
            
            try {
                const jsonData = JSON.parse(data);
                if (jsonData.success !== undefined) {
                    if (jsonData.success) {
                        resultDiv.className += ' success';
                        testResults.passed++;
                    } else {
                        resultDiv.className += ' error';
                        testResults.failed++;
                    }
                } else {
                    resultDiv.className += ' warning';
                    testResults.warnings++;
                }
            } catch (e) {
                if (data.includes('error') || data.includes('Error') || data.includes('fail')) {
                    resultDiv.className += ' error';
                    testResults.failed++;
                } else {
                    resultDiv.className += ' warning';
                    testResults.warnings++;
                }
            }
            
            resultDiv.innerHTML = `
                <h4>${operation}()</h4>
                <pre>${data}</pre>
            `;
            container.appendChild(resultDiv);
            updateSummary();
        }

        function displayError(operation, error, containerId) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result error';
            testResults.failed++;
            
            resultDiv.innerHTML = `
                <h4>${operation}() - ERROR</h4>
                <pre>${error}</pre>
            `;
            container.appendChild(resultDiv);
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('summary');
            summary.innerHTML = `
                <h3>Test Summary</h3>
                <p><strong>Total Tests:</strong> ${testResults.total}</p>
                <p><strong>Passed:</strong> <span style="color: green;">${testResults.passed}</span></p>
                <p><strong>Failed:</strong> <span style="color: red;">${testResults.failed}</span></p>
                <p><strong>Warnings:</strong> <span style="color: orange;">${testResults.warnings}</span></p>
                <p><strong>Success Rate:</strong> ${testResults.total > 0 ? Math.round((testResults.passed / testResults.total) * 100) : 0}%</p>
            `;
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            setTimeout(() => {
                testFunction('bookingList');
                testFunction('chargesMasterList');
                testFunction('getChargesCategory');
            }, 1000);
        };
    </script>
</body>
</html>
